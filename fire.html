<html>
  <head>
    <title>Fire</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <style>
        body {
          overflow: hidden;
        }
        span {
            color: white;
        }
    </style>
  </head>
  <body style='background: #000'>
    <div><span>red</span><input placeholder="red" id="red" value="255"></input></div>
    <div><span>green</span><input placeholder="green" id="green" value="0"></input></div>
    <div><span>blue</span><input placeholder="blue" id="blue" value="255"></input></div>
    <div><span>size</span><input placeholder="size" id="size" value="20"></input></div>
    <div><span>particle count</span><input placeholder="particle count" id="particles" value="1000"></input></div>
    <div><span>rise speed</span><input placeholder="rise speed" id="riseSpeed" value="3"></input></div>
    <div><span>x variance</span><input placeholder="x variance" id="xVariance" value="20"></input></div>
    <div><span>y variance</span><input placeholder="y variance" id="yVariance" value="20"></input></div>
    <div><span>radian max</span><input placeholder="radian max" id="radianMax" value="50"></input></div>
    <div><span>weird multiplier</span><input placeholder="weird multiplier" id="weirdMultiplier" value="10"></input></div>
    <div><span>decay speed</span><input placeholder="decay speed" id="decaySpeed" value="1"></input></div>

    <canvas id='display' width='1' height='1' />

    <script>

      function setConstants() {
        constants.red = document.getElementById('red').value;
        constants.green = document.getElementById('green').value;
        constants.blue = document.getElementById('blue').value;
        constants.size = document.getElementById('size').value;
        constants.particleCount = document.getElementById('particles').value;
        constants.riseSpeed = document.getElementById('riseSpeed').value;
        constants.xVariance = document.getElementById('xVariance').value;
        constants.yVariance = document.getElementById('yVariance').value;
        constants.radianMax = document.getElementById('radianMax').value;
        constants.weirdMultiplier = document.getElementById('weirdMultiplier').value;
        constants.decaySpeed = document.getElementById('decaySpeed').value;
      }

      function Particle(x, y, size, color, center) {
        this.x = x;
        this.y = y;
        this.size = size;
        this.color = color;
        this.center = center;
      }

      Particle.prototype.draw = function() {
        ctx.strokeStyle = "rgba(255, 255, 255, 0)";
        ctx.lineWidth = 0;

        this.y -= constants.riseSpeed;
        this.x += Math.random() * ((this.center - this.x) / 40);
        //this.x += ((this.center - this.x) / 100);
        //this.size -= Math.random();

        this.size = Math.max(this.size - (constants.decaySpeed * Math.random()), 0);

        //ctx.fillStyle = "rgba(155, 0, 0, .5)";
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI*2, true); 
        ctx.closePath();
        ctx.fill();

        ctx.stroke();
      };
      var display = document.getElementById('display');
      var ctx = display.getContext('2d');
      var particles = [];
      var width = display.width = window.innerWidth;
      var height = display.height = window.innerHeight;
      var mouse = {
        x: width / 2,
        y: height / 2
      };

      var constants = {};

      setConstants();

      /*display.addEventListener('mousemove', function(e) {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
      });*/

      requestAnimationFrame(frame);
      function frame() {
        requestAnimationFrame(frame);
        ctx.clearRect(0, 0, width, height);
        var stillVisibleParticles = [];
        particles.forEach(function(particle) {
            particle.draw();
            if (particle.size > 0) {
                stillVisibleParticles.push(particle);
            }

        });

        particles = stillVisibleParticles;

        // TODO - Instead of creating new particles, just reset the old ones.
        addParticles(particles, constants.particleCount - particles.length);
      }

      function getXAndY() {
        var degrees = Math.random() * 360,
            //radians = Math.random() * 25;
            radians = Math.random() * constants.radianMax;

        return {
            radians: radians,
            x: radians * Math.cos(degrees),
            y: radians * Math.sin(degrees)
        };
      }

      function rcHelper(color, xAndY) {
        return Math.floor(Math.min(color / xAndY.radians * constants.weirdMultiplier, 255));
      }

      function randomColors(xAndY) {
        return [rcHelper(constants.red, xAndY), rcHelper(constants.green, xAndY), rcHelper(constants.blue, xAndY)].join(',');
      }

      function addParticles(particleArray, numToAdd) {

        setConstants();
        //numToAdd = Math.min(numToAdd, 1);
        numToAdd = numToAdd / 3;

        for (var i = 0; i < numToAdd; i++) {
          var xAndY = getXAndY();
          var color = 'rgba(' + randomColors(xAndY) + ',.1)';
          
          //particleArray.push(new Particle(mouse.x + Math.random() - .5) * 50), mouse.y + ((Math.random() - .5) * 50), constants.size));
          particleArray.push(new Particle( ((Math.random() - .5) * 20) + (mouse.x + xAndY.x), -50 + mouse.y + xAndY.y, constants.size, color, mouse.x));
        }
      }

    </script>
  </body>
</html>
